<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat & Order Transaction Testing</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/laravel-echo@1.15.3/dist/echo.iife.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .login-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .user-login {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-login h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        button.danger {
            background: #dc3545;
        }

        button.danger:hover {
            background: #c82333;
        }

        button.success {
            background: #28a745;
        }

        button.success:hover {
            background: #218838;
        }

        .user-info {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 13px;
        }

        .user-info.logged-out {
            background: #ffebee;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .chat-section, .orders-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        .section-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            border-radius: 10px 10px 0 0;
        }

        .section-header h2 {
            font-size: 18px;
            color: #333;
        }

        .conversations-list {
            padding: 10px;
            border-bottom: 1px solid #eee;
            max-height: 150px;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .conversation-item:hover {
            background: #f8f9fa;
        }

        .conversation-item.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #fafafa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.sent {
            align-items: flex-end;
        }

        .message.received {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 15px;
            word-wrap: break-word;
        }

        .message.sent .message-bubble {
            background: #007bff;
            color: white;
        }

        .message.received .message-bubble {
            background: white;
            border: 1px solid #ddd;
        }

        .message-meta {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .message-input {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            background: white;
        }

        .message-form {
            display: flex;
            gap: 10px;
        }

        .message-form input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .orders-list {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .order-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .order-card h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .order-amount {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
            margin: 10px 0;
        }

        .order-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .order-status.pending { background: #fff3cd; color: #856404; }
        .order-status.accepted { background: #d1ecf1; color: #0c5460; }
        .order-status.in_progress { background: #cce5ff; color: #004085; }
        .order-status.delivered { background: #e2e3e5; color: #383d41; }
        .order-status.completed { background: #d4edda; color: #155724; }
        .order-status.dispute { background: #f8d7da; color: #721c24; }

        .order-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .order-actions button {
            flex: 1;
            min-width: 120px;
        }

        .create-order-form {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-indicator.online {
            background: #28a745;
        }

        .status-indicator.offline {
            background: #dc3545;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .error {
            background: #dc3545;
        }

        .info {
            background: #17a2b8;
        }

        .tabs {
            display: flex;
            gap: 10px;
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }

        .tab {
            padding: 8px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 5px;
        }

        .tab.active {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔥 Chat & Order Transaction Testing Tool</h1>
            <p style="margin-top: 10px; color: #666;">Test your Laravel API with real-time chat and escrow order transactions</p>
        </div>

        <!-- Login Section -->
        <div class="login-section">
            <!-- User 1 -->
            <div class="user-login" id="user1-login">
                <h3>👤 User 1</h3>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="user1-email" value="test1@example.com" placeholder="Enter email">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="user1-password" value="password" placeholder="Enter password">
                </div>
                <button onclick="login(1)">Login User 1</button>
                <button onclick="logout(1)" style="margin-left: 10px; background: #6c757d;">Logout</button>
                <div id="user1-info" class="user-info logged-out">Not logged in</div>
            </div>

            <!-- User 2 -->
            <div class="user-login" id="user2-login">
                <h3>👤 User 2</h3>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="user2-email" value="test2@example.com" placeholder="Enter email">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="user2-password" value="password" placeholder="Enter password">
                </div>
                <button onclick="login(2)">Login User 2</button>
                <button onclick="logout(2)" style="margin-left: 10px; background: #6c757d;">Logout</button>
                <div id="user2-info" class="user-info logged-out">Not logged in</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Chat Section -->
            <div class="chat-section">
                <div class="section-header">
                    <h2>💬 Chat Messages</h2>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchUser(1)">User 1 Chat</button>
                    <button class="tab" onclick="switchUser(2)">User 2 Chat</button>
                </div>

                <!-- User 1 Chat -->
                <div id="user1-chat" class="tab-content active">
                    <div class="conversations-list" id="user1-conversations">
                        <p style="color: #999; text-align: center;">Login to see conversations</p>
                    </div>
                    <div class="messages-container" id="user1-messages">
                        <p style="color: #999; text-align: center;">Select a conversation to view messages</p>
                    </div>
                    <div class="message-input">
                        <div class="message-form">
                            <input type="text" id="user1-message-input" placeholder="Type a message..." onkeypress="handleMessageKeyPress(event, 1)">
                            <button onclick="sendMessage(1)">Send</button>
                            <button onclick="refreshConversation(1)" style="background: #6c757d;">↻ Refresh</button>
                        </div>
                    </div>
                </div>

                <!-- User 2 Chat -->
                <div id="user2-chat" class="tab-content">
                    <div class="conversations-list" id="user2-conversations">
                        <p style="color: #999; text-align: center;">Login to see conversations</p>
                    </div>
                    <div class="messages-container" id="user2-messages">
                        <p style="color: #999; text-align: center;">Select a conversation to view messages</p>
                    </div>
                    <div class="message-input">
                        <div class="message-form">
                            <input type="text" id="user2-message-input" placeholder="Type a message..." onkeypress="handleMessageKeyPress(event, 2)">
                            <button onclick="sendMessage(2)">Send</button>
                            <button onclick="refreshConversation(2)" style="background: #6c757d;">↻ Refresh</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orders Section -->
            <div class="orders-section">
                <div class="section-header">
                    <h2>🛒 Order Transactions</h2>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchOrderUser(1)">User 1 Orders</button>
                    <button class="tab" onclick="switchOrderUser(2)">User 2 Orders</button>
                </div>

                <!-- User 1 Orders -->
                <div id="user1-orders" class="tab-content active">
                    <div class="create-order-form">
                        <h4>Create New Order</h4>
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" id="user1-order-title" placeholder="Order title">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="user1-order-description" placeholder="Describe the work needed"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Amount ($)</label>
                            <input type="number" id="user1-order-amount" placeholder="100.00" step="0.01">
                        </div>
                        <button onclick="createOrder(1)">Create Order</button>
                    </div>
                    <div class="orders-list" id="user1-orders-list">
                        <p style="color: #999; text-align: center;">No orders yet</p>
                    </div>
                </div>

                <!-- User 2 Orders -->
                <div id="user2-orders" class="tab-content">
                    <div class="create-order-form">
                        <h4>Create New Order</h4>
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" id="user2-order-title" placeholder="Order title">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="user2-order-description" placeholder="Describe the work needed"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Amount ($)</label>
                            <input type="number" id="user2-order-amount" placeholder="100.00" step="0.01">
                        </div>
                        <button onclick="createOrder(2)">Create Order</button>
                    </div>
                    <div class="orders-list" id="user2-orders-list">
                        <p style="color: #999; text-align: center;">No orders yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = window.location.origin + '/api/v1';
        const WS_HOST = window.location.hostname;
        const WS_PORT = 6001;

        // State
        const state = {
            user1: { token: null, user: null, conversations: [], currentConversation: null, echo: null },
            user2: { token: null, user: null, conversations: [], currentConversation: null, echo: null }
        };

        // Utility Functions
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        function getAxiosConfig(userNum) {
            const token = state[`user${userNum}`].token;
            return token ? { headers: { 'Authorization': `Bearer ${token}` } } : {};
        }

        // Authentication
        async function login(userNum) {
            const email = document.getElementById(`user${userNum}-email`).value;
            const password = document.getElementById(`user${userNum}-password`).value;

            try {
                const response = await axios.post(`${API_BASE_URL}/auth/login`, { email, password });
                const { token, user } = response.data;

                state[`user${userNum}`] = {
                    ...state[`user${userNum}`],
                    token,
                    user
                };

                document.getElementById(`user${userNum}-info`).className = 'user-info';
                document.getElementById(`user${userNum}-info`).innerHTML = `
                    ✅ Logged in as <strong>${user.name || user.email}</strong><br>
                    Balance: $${user.balance || 0}
                `;

                showNotification(`User ${userNum} logged in successfully!`);

                // Initialize WebSocket
                initializeWebSocket(userNum);

                // Load conversations
                loadConversations(userNum);
            } catch (error) {
                showNotification(`Login failed: ${error.response?.data?.message || error.message}`, 'error');
            }
        }

        function logout(userNum) {
            if (state[`user${userNum}`].echo) {
                state[`user${userNum}`].echo.disconnect();
            }

            state[`user${userNum}`] = { token: null, user: null, conversations: [], currentConversation: null, echo: null };

            document.getElementById(`user${userNum}-info`).className = 'user-info logged-out';
            document.getElementById(`user${userNum}-info`).textContent = 'Not logged in';
            document.getElementById(`user${userNum}-conversations`).innerHTML = '<p style="color: #999; text-align: center;">Login to see conversations</p>';
            document.getElementById(`user${userNum}-messages`).innerHTML = '<p style="color: #999; text-align: center;">Select a conversation to view messages</p>';
            document.getElementById(`user${userNum}-orders-list`).innerHTML = '<p style="color: #999; text-align: center;">No orders yet</p>';

            showNotification(`User ${userNum} logged out`);
        }

        // WebSocket
        function initializeWebSocket(userNum) {
            const token = state[`user${userNum}`].token;

            // Skip WebSocket for now - you can enable it once Reverb is configured
            // Just load conversations without real-time for testing
            console.log(`WebSocket disabled for testing - User ${userNum}`);
            return;

            /* Uncomment this when Reverb is running:
            try {
                state[`user${userNum}`].echo = new Echo({
                    broadcaster: 'reverb',
                    key: 'app-key',
                    wsHost: WS_HOST,
                    wsPort: WS_PORT,
                    wssPort: WS_PORT,
                    forceTLS: false,
                    enabledTransports: ['ws', 'wss'],
                    authEndpoint: API_BASE_URL + '/broadcasting/auth',
                    auth: {
                        headers: {
                            Authorization: `Bearer ${token}`
                        }
                    }
                });

                showNotification(`User ${userNum} WebSocket connected`, 'info');
            } catch (error) {
                console.error('WebSocket connection error:', error);
                showNotification(`WebSocket connection failed for User ${userNum}`, 'error');
            }
            */
        }

        function subscribeToConversation(userNum, conversationId) {
            const echo = state[`user${userNum}`].echo;
            if (!echo) return;

            echo.private(`conversation.${conversationId}`)
                .listen('MessageSent', (e) => {
                    console.log('New message received:', e);
                    if (state[`user${userNum}`].currentConversation?.id === conversationId) {
                        appendMessage(userNum, e.message);
                    }
                    showNotification('💬 New message received!', 'info');
                });
        }

        // Conversations
        async function loadConversations(userNum) {
            try {
                const response = await axios.get(`${API_BASE_URL}/chat/conversations`, getAxiosConfig(userNum));
                state[`user${userNum}`].conversations = response.data.data;
                renderConversations(userNum);

                // Auto-create conversation if other user is logged in
                const otherUser = userNum === 1 ? 2 : 1;
                if (state[`user${otherUser}`].user && state[`user${userNum}`].conversations.length === 0) {
                    await createConversation(userNum, state[`user${otherUser}`].user.id);
                }
            } catch (error) {
                console.error('Failed to load conversations:', error);
            }
        }

        async function createConversation(userNum, otherUserId) {
            try {
                const response = await axios.post(`${API_BASE_URL}/chat/conversations`,
                    { other_user_id: otherUserId },
                    getAxiosConfig(userNum)
                );
                showNotification('Conversation created!', 'success');
                loadConversations(userNum);
            } catch (error) {
                console.error('Failed to create conversation:', error);
            }
        }

        function renderConversations(userNum) {
            const container = document.getElementById(`user${userNum}-conversations`);
            const conversations = state[`user${userNum}`].conversations;

            if (conversations.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">No conversations yet</p>';
                return;
            }

            container.innerHTML = conversations.map(conv => {
                const otherUser = conv.other_participant;
                return `
                    <div class="conversation-item ${state[`user${userNum}`].currentConversation?.id === conv.id ? 'active' : ''}"
                         onclick="selectConversation(${userNum}, ${conv.id})">
                        <div>
                            <strong>${otherUser.name || otherUser.email}</strong>
                            <div style="font-size: 12px; color: #999;">ID: ${conv.id}</div>
                        </div>
                        <div style="font-size: 11px; color: #999;">${conv.messages_count || 0} msgs</div>
                    </div>
                `;
            }).join('');
        }

        async function selectConversation(userNum, conversationId) {
            try {
                const response = await axios.get(`${API_BASE_URL}/chat/conversations/${conversationId}`, getAxiosConfig(userNum));
                state[`user${userNum}`].currentConversation = response.data.data;

                renderConversations(userNum);
                renderMessages(userNum, response.data.data.messages || []);

                // Subscribe to real-time updates
                subscribeToConversation(userNum, conversationId);

                // Load orders for this conversation
                loadOrders(userNum, conversationId);
            } catch (error) {
                console.error('Failed to load conversation:', error);
            }
        }

        // Messages
        function renderMessages(userNum, messages) {
            const container = document.getElementById(`user${userNum}-messages`);
            const currentUserId = state[`user${userNum}`].user.id;

            if (messages.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">No messages yet. Start the conversation!</p>';
                return;
            }

            container.innerHTML = messages.map(msg => {
                const isSent = msg.user_id === currentUserId;
                return `
                    <div class="message ${isSent ? 'sent' : 'received'}">
                        <div class="message-bubble">
                            ${msg.content || '[File message]'}
                        </div>
                        <div class="message-meta">
                            ${msg.user.name || msg.user.email} • ${formatTime(msg.created_at)}
                        </div>
                    </div>
                `;
            }).join('');

            container.scrollTop = container.scrollHeight;
        }

        function appendMessage(userNum, message) {
            const container = document.getElementById(`user${userNum}-messages`);
            const currentUserId = state[`user${userNum}`].user.id;
            const isSent = message.user_id === currentUserId;

            const messageEl = document.createElement('div');
            messageEl.className = `message ${isSent ? 'sent' : 'received'}`;
            messageEl.innerHTML = `
                <div class="message-bubble">
                    ${message.content || '[File message]'}
                </div>
                <div class="message-meta">
                    ${message.user.name || message.user.email} • ${formatTime(message.created_at)}
                </div>
            `;

            container.appendChild(messageEl);
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage(userNum) {
            const input = document.getElementById(`user${userNum}-message-input`);
            const content = input.value.trim();

            if (!content || !state[`user${userNum}`].currentConversation) {
                showNotification('Please select a conversation and type a message', 'error');
                return;
            }

            try {
                const conversationId = state[`user${userNum}`].currentConversation.id;
                const response = await axios.post(
                    `${API_BASE_URL}/chat/conversations/${conversationId}/messages`,
                    { content },
                    getAxiosConfig(userNum)
                );

                input.value = '';
                // Message will be added via WebSocket event
            } catch (error) {
                showNotification(`Failed to send message: ${error.response?.data?.message || error.message}`, 'error');
            }
        }

        function handleMessageKeyPress(event, userNum) {
            if (event.key === 'Enter') {
                sendMessage(userNum);
            }
        }

        // Orders
        async function createOrder(userNum) {
            const title = document.getElementById(`user${userNum}-order-title`).value.trim();
            const description = document.getElementById(`user${userNum}-order-description`).value.trim();
            const amount = document.getElementById(`user${userNum}-order-amount`).value;

            if (!title || !description || !amount) {
                showNotification('Please fill in all order fields', 'error');
                return;
            }

            if (!state[`user${userNum}`].currentConversation) {
                showNotification('Please select a conversation first', 'error');
                return;
            }

            try {
                const conversationId = state[`user${userNum}`].currentConversation.id;
                const otherUserId = state[`user${userNum}`].currentConversation.other_participant.id;

                const response = await axios.post(
                    `${API_BASE_URL}/chat/conversations/${conversationId}/transactions`,
                    {
                        conversation_id: conversationId,
                        executor_id: otherUserId,
                        title,
                        description,
                        amount: parseFloat(amount)
                    },
                    getAxiosConfig(userNum)
                );

                showNotification('Order created successfully! 🎉', 'success');

                // Clear form
                document.getElementById(`user${userNum}-order-title`).value = '';
                document.getElementById(`user${userNum}-order-description`).value = '';
                document.getElementById(`user${userNum}-order-amount`).value = '';

                // Reload orders
                loadOrders(userNum, conversationId);

                // Reload messages (order appears as message)
                selectConversation(userNum, conversationId);
            } catch (error) {
                showNotification(`Failed to create order: ${error.response?.data?.message || error.message}`, 'error');
            }
        }

        async function loadOrders(userNum, conversationId) {
            try {
                const response = await axios.get(
                    `${API_BASE_URL}/chat/conversations/${conversationId}/transactions`,
                    getAxiosConfig(userNum)
                );

                renderOrders(userNum, response.data.data || []);
            } catch (error) {
                console.error('Failed to load orders:', error);
            }
        }

        function renderOrders(userNum, orders) {
            const container = document.getElementById(`user${userNum}-orders-list`);

            if (orders.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">No orders yet</p>';
                return;
            }

            container.innerHTML = orders.map(order => `
                <div class="order-card">
                    <h4>${order.title}</h4>
                    <span class="order-status ${order.status}">${order.status.replace(/_/g, ' ').toUpperCase()}</span>
                    <div class="order-amount">$${order.amount.toLocaleString()}</div>
                    <p style="color: #666; font-size: 14px; margin: 10px 0;">${order.description}</p>
                    <div style="font-size: 12px; color: #999;">
                        <strong>Creator:</strong> ${order.creator.name || order.creator.email}<br>
                        <strong>Executor:</strong> ${order.executor.name || order.executor.email}
                    </div>
                    <div class="order-actions">
                        ${order.can_accept ? `<button class="success" onclick="acceptOrder(${userNum}, ${order.id})">Accept Order</button>` : ''}
                        ${order.can_deliver ? `<button onclick="deliverOrder(${userNum}, ${order.id})">Mark Delivered</button>` : ''}
                        ${order.can_complete ? `<button class="success" onclick="completeOrder(${userNum}, ${order.id})">Complete & Pay</button>` : ''}
                        ${order.can_cancel ? `<button class="danger" onclick="cancelOrder(${userNum}, ${order.id})">Cancel Order</button>` : ''}
                        ${order.can_dispute ? `<button class="danger" onclick="disputeOrder(${userNum}, ${order.id})">Raise Dispute</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function acceptOrder(userNum, orderId) {
            try {
                await axios.post(`${API_BASE_URL}/chat/transactions/${orderId}/accept`, {}, getAxiosConfig(userNum));
                showNotification('Order accepted! Funds escrowed. 💰', 'success');
                refreshOrders(userNum);
            } catch (error) {
                showNotification(`Failed: ${error.response?.data?.message || error.message}`, 'error');
            }
        }

        async function deliverOrder(userNum, orderId) {
            try {
                await axios.post(`${API_BASE_URL}/chat/transactions/${orderId}/deliver`, {}, getAxiosConfig(userNum));
                showNotification('Work marked as delivered! ✅', 'success');
                refreshOrders(userNum);
            } catch (error) {
                showNotification(`Failed: ${error.response?.data?.message || error.message}`, 'error');
            }
        }

        async function completeOrder(userNum, orderId) {
            if (!confirm('This will release payment to the executor. Continue?')) return;

            try {
                await axios.post(`${API_BASE_URL}/chat/transactions/${orderId}/complete`, {}, getAxiosConfig(userNum));
                showNotification('Order completed! Payment released. 💸', 'success');
                refreshOrders(userNum);
            } catch (error) {
                showNotification(`Failed: ${error.response?.data?.message || error.message}`, 'error');
            }
        }

        async function cancelOrder(userNum, orderId) {
            const reason = prompt('Enter cancellation reason:');
            if (!reason) return;

            try {
                await axios.post(`${API_BASE_URL}/chat/transactions/${orderId}/cancel`, { reason }, getAxiosConfig(userNum));
                showNotification('Order cancelled. Refund processed. 🔄', 'success');
                refreshOrders(userNum);
            } catch (error) {
                showNotification(`Failed: ${error.response?.data?.message || error.message}`, 'error');
            }
        }

        async function disputeOrder(userNum, orderId) {
            const reason = prompt('Enter dispute reason (min 10 characters):');
            if (!reason || reason.length < 10) {
                showNotification('Dispute reason must be at least 10 characters', 'error');
                return;
            }

            try {
                await axios.post(`${API_BASE_URL}/chat/transactions/${orderId}/dispute`, { reason }, getAxiosConfig(userNum));
                showNotification('Dispute raised. Admin will review. ⚠️', 'info');
                refreshOrders(userNum);
            } catch (error) {
                showNotification(`Failed: ${error.response?.data?.message || error.message}`, 'error');
            }
        }

        function refreshOrders(userNum) {
            if (state[`user${userNum}`].currentConversation) {
                loadOrders(userNum, state[`user${userNum}`].currentConversation.id);
            }
        }

        function refreshConversation(userNum) {
            if (state[`user${userNum}`].currentConversation) {
                selectConversation(userNum, state[`user${userNum}`].currentConversation.id);
                showNotification('Refreshed!', 'info');
            }
        }

        // Tab Switching
        function switchUser(userNum) {
            // Switch chat tabs
            document.querySelectorAll('.chat-section .tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.chat-section .tab-content').forEach(content => content.classList.remove('active'));

            document.querySelectorAll('.chat-section .tab')[userNum - 1].classList.add('active');
            document.getElementById(`user${userNum}-chat`).classList.add('active');
        }

        function switchOrderUser(userNum) {
            // Switch order tabs
            document.querySelectorAll('.orders-section .tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.orders-section .tab-content').forEach(content => content.classList.remove('active'));

            document.querySelectorAll('.orders-section .tab')[userNum - 1].classList.add('active');
            document.getElementById(`user${userNum}-orders`).classList.add('active');
        }

        // Initialize
        console.log('🔥 Chat & Order Testing Tool Ready!');
        console.log('API Base URL:', API_BASE_URL);
        console.log('WebSocket:', `${WS_HOST}:${WS_PORT}`);
    </script>
</body>
</html>
