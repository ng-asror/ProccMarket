<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat & Orders - ProccMarket</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pusher-js@8.3.0/dist/web/pusher.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/laravel-echo@1.15.3/dist/echo.iife.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .app-container {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #667eea;
        }

        .login-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .login-box {
            width: 100%;
            max-width: 400px;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .login-box h2 {
            margin-bottom: 30px;
            color: #333;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            overflow: hidden;
        }

        .sidebar {
            background: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h3 {
            font-size: 18px;
            color: #333;
        }

        .new-chat-btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            width: auto;
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .conversation-item {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .conversation-item:hover {
            background: #e9ecef;
        }

        .conversation-item.active {
            background: #667eea;
            color: white;
        }

        .conversation-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .conversation-item.active .conversation-avatar {
            background: rgba(255,255,255,0.3);
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-preview {
            font-size: 12px;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-area {
            display: flex;
            flex-direction: column;
            background: white;
        }

        .chat-header {
            padding: 20px 30px;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
        }

        .chat-header h3 {
            font-size: 18px;
            color: #333;
            margin-bottom: 4px;
        }

        .chat-header p {
            font-size: 12px;
            color: #999;
        }

        .messages-container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #fafafa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
        }

        .message.sent {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            flex-shrink: 0;
        }

        .message-content {
            max-width: 60%;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message.sent .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.received .message-bubble {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            padding: 0 4px;
        }

        .message-input-area {
            padding: 20px 30px;
            border-top: 1px solid #e0e0e0;
            background: white;
        }

        .message-input-form {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .message-input-form input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 24px;
            font-size: 14px;
        }

        .message-input-form input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .orders-panel {
            background: #f8f9fa;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: white;
        }

        .panel-header h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 4px;
        }

        .create-order-btn {
            margin-top: 12px;
            padding: 10px 16px;
            background: #28a745;
            font-size: 14px;
        }

        .orders-list {
            padding: 15px;
        }

        .order-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .order-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .order-status.pending { background: #fff3cd; color: #856404; }
        .order-status.accepted { background: #d1ecf1; color: #0c5460; }
        .order-status.in_progress { background: #cce5ff; color: #004085; }
        .order-status.delivered { background: #e2e3e5; color: #383d41; }
        .order-status.completed { background: #d4edda; color: #155724; }
        .order-status.dispute { background: #f8d7da; color: #721c24; }
        .order-status.released { background: #d4edda; color: #155724; }

        .order-title {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            margin-bottom: 6px;
        }

        .order-amount {
            font-size: 20px;
            font-weight: bold;
            color: #28a745;
            margin: 10px 0;
        }

        .order-description {
            font-size: 13px;
            color: #666;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .order-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .order-actions button {
            padding: 8px 12px;
            font-size: 13px;
            border-radius: 6px;
        }

        .btn-success { background: #28a745; }
        .btn-primary { background: #007bff; }
        .btn-danger { background: #dc3545; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 20px;
            color: #333;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-footer button {
            width: auto;
            padding: 10px 20px;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 16px 24px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            animation: slideIn 0.3s ease;
            max-width: 350px;
        }

        .notification.error { background: #dc3545; }
        .notification.info { background: #17a2b8; }
        .notification.warning { background: #ffc107; color: #333; }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .refresh-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #6c757d;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .ws-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .ws-status.connected { background: #28a745; }
        .ws-status.disconnected { background: #dc3545; }
    </style>
</head>
<body>
    <div class="app-container" id="app">
        <!-- Login Screen -->
        <div class="login-container" id="login-screen">
            <div class="login-box">
                <h2>üîê Login to ProccMarket</h2>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="login-email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password">
                </div>
                <button onclick="login()">Login</button>
            </div>
        </div>

        <!-- Main App -->
        <div id="main-app" style="display: none; flex: 1; display: flex; flex-direction: column;">
            <div class="header">
                <h1>
                    üí¨ ProccMarket Chat
                    <span class="ws-status disconnected" id="ws-status"></span>
                </h1>
                <div class="user-badge">
                    <div class="user-avatar" id="user-avatar">?</div>
                    <div>
                        <div style="font-weight: 600;" id="user-name">User</div>
                        <div style="font-size: 12px; opacity: 0.9;">Balance: $<span id="user-balance">0</span></div>
                    </div>
                    <button onclick="logout()" style="margin-left: 15px; width: auto; padding: 8px 16px; background: rgba(255,255,255,0.2); font-size: 12px;">Logout</button>
                </div>
            </div>

            <div class="main-content">
                <div class="sidebar">
                    <div class="sidebar-header">
                        <h3>Conversations</h3>
                        <button class="new-chat-btn" onclick="showNewChatModal()">+ New</button>
                    </div>
                    <div class="conversations-list" id="conversations-list">
                        <div class="empty-state">
                            <p>No conversations yet</p>
                        </div>
                    </div>
                </div>

                <div class="chat-area">
                    <div class="chat-header" id="chat-header" style="display: none;">
                        <h3 id="chat-name">Select a conversation</h3>
                        <p id="chat-info">No conversation selected</p>
                    </div>
                    <div class="messages-container" id="messages-container" style="max-height: 60vh;">
                        <div class="empty-state">
                            <p>Select a conversation to start chatting</p>
                        </div>
                    </div>
                    <div class="message-input-area" style="display: none;" id="message-input-area">
                        <div class="message-input-form">
                            <input type="text" id="message-input" placeholder="Type a message..." onkeypress="handleKeyPress(event)">
                            <button class="refresh-btn" onclick="refreshConversation()">‚Üª</button>
                            <button class="send-btn" onclick="sendMessage()">‚û§</button>
                        </div>
                    </div>
                </div>

                <div class="orders-panel">
                    <div class="panel-header">
                        <h3>üì¶ Order Transactions</h3>
                        <p style="font-size: 12px; color: #999; margin-top: 4px;">Secure escrow system</p>
                        <button class="create-order-btn" onclick="showCreateOrderModal()" id="create-order-btn" style="display: none;">+ Create Order</button>
                    </div>
                    <div class="orders-list" id="orders-list">
                        <div class="empty-state" style="padding: 40px 20px;">
                            <p>No orders yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="new-chat-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Start New Conversation</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Enter User ID to chat with:</label>
                    <input type="number" id="new-chat-user-id" placeholder="User ID" style="width: 100%;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('new-chat-modal')">Cancel</button>
                <button onclick="createConversation()">Start Chat</button>
            </div>
        </div>
    </div>

    <div class="modal" id="create-order-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Order Transaction</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="order-title" placeholder="e.g., Build a website">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="order-description" placeholder="Describe the work required..."></textarea>
                </div>
                <div class="form-group">
                    <label>Amount ($)</label>
                    <input type="number" id="order-amount" placeholder="100.00" step="0.01" min="0.01">
                </div>
                <div class="form-group">
                    <label>Deadline (Optional)</label>
                    <input type="date" id="order-deadline">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('create-order-modal')">Cancel</button>
                <button class="btn-success" onclick="createOrder()">Create Order</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin + '/api/v1';
        
        let state = {
            token: null,
            user: null,
            conversations: [],
            currentConversation: null,
            echo: null,
            wsConnected: false
        };

        // Utility Functions
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function getAxiosConfig() {
            return state.token ? { headers: { 'Authorization': `Bearer ${state.token}` } } : {};
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') sendMessage();
        }

        function updateWSStatus(connected) {
            state.wsConnected = connected;
            const statusEl = document.getElementById('ws-status');
            if (statusEl) {
                statusEl.className = `ws-status ${connected ? 'connected' : 'disconnected'}`;
            }
        }

        // Authentication
        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showNotification('Please enter email and password', 'error');
                return;
            }

            try {
                const response = await axios.post(`${API_BASE_URL}/auth/login`, { email, password });
                const { token, user } = response.data;

                state.token = token;
                state.user = user;

                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                document.getElementById('user-name').textContent = user.name || user.email;
                document.getElementById('user-balance').textContent = user.balance || 0;
                document.getElementById('user-avatar').textContent = (user.name || user.email).charAt(0).toUpperCase();

                showNotification('Logged in successfully! üéâ');

                // Try to initialize WebSocket (non-blocking)
                initializeWebSocket();

                // Load conversations
                await loadConversations();
            } catch (error) {
                showNotification(error.response?.data?.message || 'Login failed', 'error');
            }
        }

        function logout() {
            if (state.echo) {
                try { state.echo.disconnect(); } catch(e) {}
            }
            
            state = { token: null, user: null, conversations: [], currentConversation: null, echo: null, wsConnected: false };
            
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            
            showNotification('Logged out successfully');
        }

        // WebSocket (Non-blocking)
        function initializeWebSocket() {
            console.log('üîå Attempting WebSocket connection...');
            console.log('üîë Token:', state.token ? 'Present' : 'Missing');
            console.log('üåê WS Host: 127.0.0.1:8080');
            
            // Enable Pusher logging
            if (typeof Pusher !== 'undefined') {
                Pusher.logToConsole = true;
            }
            
            try {
                // IMPORTANT: Use 'pusher' broadcaster for Reverb (not 'reverb')
                // Reverb uses Pusher protocol
                const echoConfig = {
                    broadcaster: 'pusher', // ‚Üê CHANGED from 'reverb' to 'pusher'
                    key: 'pfhvoct1m3qrpxulyis8',
                    wsHost: '127.0.0.1',
                    wsPort: 8080,
                    wssPort: 8080,
                    forceTLS: false,
                    enabledTransports: ['ws'],
                    disableStats: true,
                    cluster: 'mt1', // Dummy cluster (required by Pusher, ignored by Reverb)
                    authEndpoint: 'http://127.0.0.1:8000/api/v1/broadcasting/auth',
                    auth: {
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Accept': 'application/json'
                        }
                    }
                };
                
                console.log('üì° Creating Echo instance with Pusher broadcaster...');
                
                state.echo = new Echo(echoConfig);

                // Check if Echo created successfully
                if (!state.echo) {
                    throw new Error('Echo instance not created');
                }

                console.log('‚úÖ Echo instance created');

                // Access pusher after a short delay to ensure it's initialized
                setTimeout(() => {
                    if (state.echo && state.echo.connector && state.echo.connector.pusher) {
                        console.log('‚úÖ Echo pusher accessible');
                        
                        const pusher = state.echo.connector.pusher;
                        
                        pusher.connection.bind('state_change', function(states) {
                            console.log('üîÑ WebSocket State:', states.previous, '->', states.current);
                        });
                        
                        pusher.connection.bind('connecting', function() {
                            console.log('üîå Connecting to WebSocket...');
                        });
                        
                        if (pusher.connection.state === 'connected') {
                            console.log('‚úÖ WebSocket already connected!');
                            console.log('üìç Socket ID:', pusher.connection.socket_id);
                            updateWSStatus(true);
                            showNotification('Real-time chat enabled! üîî', 'success');
                        }

                        // `connected` hodisasini bog'lash
                        pusher.connection.bind('connected', function() {
                            console.log('‚úÖ WebSocket connected successfully!');
                            console.log('üìç Socket ID:', pusher.connection.socket_id);
                            updateWSStatus(true);
                            showNotification('Real-time chat enabled! üîî', 'success');
                        });

                        pusher.connection.bind('unavailable', function() {
                            console.warn('‚ö†Ô∏è WebSocket unavailable');
                            updateWSStatus(false);
                        });

                        pusher.connection.bind('failed', function() {
                            console.error('‚ùå WebSocket connection failed');
                            updateWSStatus(false);
                            showNotification('WebSocket failed - using manual refresh', 'warning');
                        });

                        pusher.connection.bind('disconnected', function() {
                            console.warn('‚ö†Ô∏è WebSocket disconnected');
                            updateWSStatus(false);
                        });

                        pusher.connection.bind('error', function(err) {
                            console.error('‚ùå WebSocket error:', err);
                            updateWSStatus(false);
                        });
                        
                    } else {
                        console.error('‚ùå Echo pusher not accessible:', {
                            echo: !!state.echo,
                            connector: !!state.echo?.connector,
                            pusher: !!state.echo?.connector?.pusher
                        });
                        state.echo = null;
                        updateWSStatus(false);
                        showNotification('WebSocket not available - using manual refresh', 'warning');
                    }
                }, 500);

            } catch (error) {
                console.error('‚ùå WebSocket initialization error:', error);
                state.echo = null;
                updateWSStatus(false);
                showNotification('Using manual refresh mode', 'warning');
            }
        }

        function subscribeToConversation(conversationId) {
            if (!state.echo || !state.wsConnected) {
                console.log('‚ö†Ô∏è WebSocket not available, skipping subscription');
                return;
            }

            try {
                console.log(`üì° Subscribing to private-conversation.${conversationId}`);
                
                const channel = state.echo.private(`conversation.${conversationId}`);
                
                // Listen for new messages
                channel.listen('.message.sent', (e) => {
                    console.log('üì® New message received:', e);
                    handleNewMessage(e, conversationId);
                });

                channel.listen('MessageSent', (e) => {
                    console.log('üì® New message received (format 2):', e);
                    handleNewMessage(e, conversationId);
                });
                
                // Also listen to notification event for debugging
                channel.notification((notification) => {
                    console.log('üîî Notification received:', notification);
                });

                // Listen for errors
                channel.error((error) => {
                    console.error('‚ùå Channel subscription error:', error);
                });

                console.log('‚úÖ Successfully subscribed to conversation channel');
                
            } catch (error) {
                console.error('‚ùå Failed to subscribe to conversation:', error);
            }
        }

        function handleNewMessage(event, conversationId) {
            console.log('üì• Processing new message:', event);
            
            // If we're viewing this conversation, just append the new message
            if (state.currentConversation?.id === conversationId) {
                const message = event.message || event;
                appendMessage(message);
            }
            
            // Update conversations list (only once, not multiple times)
            if (!state.conversationsRefreshTimeout) {
                state.conversationsRefreshTimeout = setTimeout(() => {
                    loadConversations();
                    state.conversationsRefreshTimeout = null;
                }, 1000); // Debounce: only refresh once per second
            }
            
            showNotification('üí¨ New message received!', 'info');
        }

        function appendMessage(msg) {
            const container = document.getElementById('messages-container');
            
            // Check if empty state exists, remove it
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            const isSent = msg.user_id === state.user.id;
            const initial = (msg.user?.name || msg.user?.email || '?').charAt(0).toUpperCase();
            
            const messageHTML = `
                <div class="message ${isSent ? 'sent' : 'received'}">
                    <div class="message-avatar">${initial}</div>
                    <div class="message-content">
                        <div class="message-bubble">
                            ${msg.content || '[File message]'}
                        </div>
                        <div class="message-time">${formatTime(msg.created_at || new Date().toISOString())}</div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', messageHTML);
            container.scrollTop = container.scrollHeight;
        }

        // Conversations
        async function loadConversations() {
            try {
                const response = await axios.get(`${API_BASE_URL}/chat/conversations`, getAxiosConfig());
                state.conversations = response.data.data || [];
                renderConversations();
            } catch (error) {
                console.error('Failed to load conversations:', error);
                if (!error.message.includes('socketId')) {
                    showNotification('Failed to load conversations', 'error');
                }
            }
        }

        function renderConversations() {
            const container = document.getElementById('conversations-list');

            if (state.conversations.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No conversations yet<br>Click "+ New" to start</p></div>';
                return;
            }

            container.innerHTML = state.conversations.map(conv => {
                const otherUser = conv.other_participant;
                const initial = (otherUser.name || otherUser.email).charAt(0).toUpperCase();
                const isActive = state.currentConversation?.id === conv.id;

                return `
                    <div class="conversation-item ${isActive ? 'active' : ''}" onclick="selectConversation(${conv.id})">
                        <div class="conversation-avatar">${initial}</div>
                        <div class="conversation-info">
                            <div class="conversation-name">${otherUser.name || otherUser.email}</div>
                            <div class="conversation-preview">${conv.messages_count || 0} messages</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function selectConversation(conversationId) {
            try {
                const response = await axios.get(`${API_BASE_URL}/chat/conversations/${conversationId}`, getAxiosConfig());

                state.currentConversation = response.data.conversation;
                const messages = response.data.messages || [];

                document.getElementById('chat-header').style.display = 'block';
                document.getElementById('message-input-area').style.display = 'block';
                document.getElementById('create-order-btn').style.display = 'block';

                const otherUser = state.currentConversation.other_participant;
                document.getElementById('chat-name').textContent = otherUser.name || otherUser.email;
                document.getElementById('chat-info').textContent = otherUser.email;

                renderConversations();
                renderMessages(messages);
                subscribeToConversation(conversationId);
                loadOrders();
            } catch (error) {
                console.error('Failed to load conversation:', error);
                showNotification('Failed to load conversation', 'error');
            }
        }

        function refreshConversation() {
            if (state.currentConversation) {
                selectConversation(state.currentConversation.id);
                showNotification('Refreshed!', 'info');
            }
        }

        async function showNewChatModal() {
            document.getElementById('new-chat-modal').classList.add('active');
        }

        async function createConversation() {
            const otherUserId = document.getElementById('new-chat-user-id')?.value;

            if (!otherUserId) {
                showNotification('Please enter a user ID', 'error');
                return;
            }

            try {
                const response = await axios.post(`${API_BASE_URL}/chat/conversations`,
                    { user_id: parseInt(otherUserId) },
                    getAxiosConfig()
                );

                closeModal('new-chat-modal');
                showNotification('Conversation created! üéâ');
                loadConversations();
                selectConversation(response.data.data.id);
            } catch (error) {
                showNotification(error.response?.data?.message || 'Failed to create conversation', 'error');
            }
        }

        // Messages
        function renderMessages(messages) {
            const container = document.getElementById('messages-container');

            if (messages.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No messages yet<br>Start the conversation!</p></div>';
                return;
            }

            container.innerHTML = messages.map(msg => {
                const isSent = msg.user_id === state.user.id;
                const initial = (msg.user.name || msg.user.email).charAt(0).toUpperCase();

                return `
                    <div class="message ${isSent ? 'sent' : 'received'}">
                        <div class="message-avatar">${initial}</div>
                        <div class="message-content">
                            <div class="message-bubble">
                                ${msg.content || '[File message]'}
                            </div>
                            <div class="message-time">${formatTime(msg.created_at)}</div>
                        </div>
                    </div>
                `;
            }).join('');

            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();

            if (!content || !state.currentConversation) return;

            try {
                await axios.post(
                    `${API_BASE_URL}/chat/conversations/${state.currentConversation.id}/messages`,
                    { content },
                    getAxiosConfig()
                );

                input.value = '';
                // setTimeout(() => selectConversation(state.currentConversation.id), 300);
            } catch (error) {
                showNotification('Failed to send message', 'error');
            }
        }

        // Orders
        async function loadOrders() {
            if (!state.currentConversation) return;

            try {
                const response = await axios.get(
                    `${API_BASE_URL}/chat/conversations/${state.currentConversation.id}/transactions`,
                    getAxiosConfig()
                );

                renderOrders(response.data.data || []);
            } catch (error) {
                console.error('Failed to load orders:', error);
            }
        }

        function renderOrders(orders) {
            const container = document.getElementById('orders-list');

            if (orders.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 40px 20px;"><p>No orders yet<br>Create one to get started!</p></div>';
                return;
            }

            container.innerHTML = orders.map(order => `
                <div class="order-card">
                    <span class="order-status ${order.status}">${order.status.replace(/_/g, ' ')}</span>
                    <div class="order-title">${order.title}</div>
                    <div class="order-amount">${order.amount.toLocaleString()}</div>
                    <div class="order-description">${order.description}</div>
                    <div class="order-actions">
                        ${order.can_accept ? `<button class="btn-success" onclick="acceptOrder(${order.id})">‚úì Accept Order</button>` : ''}
                        ${order.can_deliver ? `<button class="btn-primary" onclick="deliverOrder(${order.id})">üì¶ Mark Delivered</button>` : ''}
                        ${order.can_complete ? `<button class="btn-success" onclick="completeOrder(${order.id})">‚úì Complete & Pay</button>` : ''}
                        ${order.can_cancel ? `<button class="btn-danger" onclick="cancelOrder(${order.id})">‚úó Cancel</button>` : ''}
                        ${order.can_dispute ? `<button class="btn-danger" onclick="disputeOrder(${order.id})">‚ö† Dispute</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function showCreateOrderModal() {
            if (!state.currentConversation) {
                showNotification('Please select a conversation first', 'error');
                return;
            }
            document.getElementById('create-order-modal').classList.add('active');
        }

        async function createOrder() {
            const title = document.getElementById('order-title').value.trim();
            const description = document.getElementById('order-description').value.trim();
            const amount = document.getElementById('order-amount').value;
            const deadline = document.getElementById('order-deadline').value;

            if (!title || !description || !amount) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            try {
                const data = {
                    conversation_id: state.currentConversation.id,
                    executor_id: state.currentConversation.other_participant.id,
                    title,
                    description,
                    amount: parseFloat(amount)
                };

                if (deadline) data.deadline = deadline;

                await axios.post(
                    `${API_BASE_URL}/chat/conversations/${state.currentConversation.id}/transactions`,
                    data,
                    getAxiosConfig()
                );

                closeModal('create-order-modal');
                showNotification('Order created successfully! üéâ');

                document.getElementById('order-title').value = '';
                document.getElementById('order-description').value = '';
                document.getElementById('order-amount').value = '';
                document.getElementById('order-deadline').value = '';

                loadOrders();
                selectConversation(state.currentConversation.id);
            } catch (error) {
                showNotification(error.response?.data?.message || 'Failed to create order', 'error');
            }
        }

        async function acceptOrder(orderId) {
            try {
                await axios.post(`${API_BASE_URL}/chat/transactions/${orderId}/accept`, {}, getAxiosConfig());
                showNotification('Order accepted! Funds escrowed. üí∞');
                loadOrders();
                selectConversation(state.currentConversation.id);
            } catch (error) {
                showNotification(error.response?.data?.message || 'Failed to accept order', 'error');
            }
        }

        async function deliverOrder(orderId) {
            try {
                await axios.post(`${API_BASE_URL}/chat/transactions/${orderId}/deliver`, {}, getAxiosConfig());
                showNotification('Work marked as delivered! ‚úÖ');
                loadOrders();
            } catch (error) {
                showNotification(error.response?.data?.message || 'Failed', 'error');
            }
        }

        async function completeOrder(orderId) {
            if (!confirm('This will release payment to the executor. Continue?')) return;

            try {
                await axios.post(`${API_BASE_URL}/chat/transactions/${orderId}/complete`, {}, getAxiosConfig());
                showNotification('Order completed! Payment released. üí∏');
                loadOrders();
                const response = await axios.get(`${API_BASE_URL}/auth/me`, getAxiosConfig());
                document.getElementById('user-balance').textContent = response.data.balance || 0;
            } catch (error) {
                showNotification(error.response?.data?.message || 'Failed', 'error');
            }
        }

        async function cancelOrder(orderId) {
            const reason = prompt('Enter cancellation reason:');
            if (!reason) return;

            try {
                await axios.post(`${API_BASE_URL}/chat/transactions/${orderId}/cancel`, { reason }, getAxiosConfig());
                showNotification('Order cancelled. Refund processed. üîÑ');
                loadOrders();
            } catch (error) {
                showNotification(error.response?.data?.message || 'Failed', 'error');
            }
        }

        async function disputeOrder(orderId) {
            const reason = prompt('Enter dispute reason (min 10 characters):');
            if (!reason || reason.length < 10) {
                showNotification('Dispute reason must be at least 10 characters', 'error');
                return;
            }

            try {
                await axios.post(`${API_BASE_URL}/chat/transactions/${orderId}/dispute`, { reason }, getAxiosConfig());
                showNotification('Dispute raised. Admin will review. ‚ö†Ô∏è', 'info');
                loadOrders();
            } catch (error) {
                showNotification(error.response?.data?.message || 'Failed', 'error');
            }
        }

        console.log('üí¨ ProccMarket Chat Ready!');
        console.log('üìù Note: Real-time updates require Reverb server running on port 8080');
        console.log('üîÑ Use the refresh button (‚Üª) to manually update messages');
    </script>
</body>
</html>